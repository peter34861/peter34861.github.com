<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: 脚本篇 | 痞子_朱 运维之路.....]]></title>
  <link href="http://peter34861.github.io/blog/categories/jiao-ben-pian/atom.xml" rel="self"/>
  <link href="http://peter34861.github.io/"/>
  <updated>2014-04-14T17:25:45+08:00</updated>
  <id>http://peter34861.github.io/</id>
  <author>
    <name><![CDATA[Peter Zhu]]></name>
    <email><![CDATA[zhuwen5720@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Xtrabackup 备份数据库]]></title>
    <link href="http://peter34861.github.io/blog/2013/01/28/xtrabackup/"/>
    <updated>2013-01-28T00:00:00+08:00</updated>
    <id>http://peter34861.github.io/blog/2013/01/28/xtrabackup</id>
    <content type="html"><![CDATA[<p>最近为了备份做一个数据全量备份和增量备份 写了一个脚本，</p>




<p>策略：每天零点做全量备份    每小时做增量备份</p>




<p>脚本写的很烂，只是给自己提供备份，欢迎拍砖。</p>




<p>#!/bin/bash<br />
# To backup mysql<br />
#
#<br />
# By peterzhu (zhuwen5720@gmail.com)<br />
#
#</p>




<p>Date=`date +%F`<br />
Add_date=`date +%F"-"%H"-"%M`<br />
Bakdir=/data1/bak/<br />
Mysql_file=/etc/my.cnf<br />
User=root<br />
Pwd=shanghai_tower<br />
Now_time=`date +%H`<br />
Last_time=`date +%H -d '1 hours ago'`<br />
Log_time=`date +%F"-"%H`</p>




<p>#####in order to tar<br />
Tar_dir=/data1/tar_bak<br />
Tar_date=`date +%F -d '1 days ago'`<br />
Rep_log=/tmp/mysql_log</p>




<p>### every day full bak</p>




<p>if [ ! -d "$Bakdir"mysqld-$Date ];then</p>




<p>mkdir -p "$Bakdir"mysqld-$Date                          #add every day full backup dir and Incremental Backup dir</p>




<p>/usr/bin/innobackupex-1.5.1 --user=$User --password=$Pwd --defaults-file=$Mysql_file --no-timestamp  "$Bakdir"mysqld-$Date/full 1&gt;&gt;$Rep_log/log_$Log_time 2&gt;&amp;1<br />
fi</p>




<p>Bak_dir="$Bakdir"mysqld-$Date</p>


<!--more-->




<p>###  The first to Rep</p>




<p>if [ ! -d "$Bakdir"mysqld-"$Date"/Rep ];then</p>




<p>mkdir -p "$Bakdir"mysqld-"$Date"/Rep                     #create rep dir</p>




<p>fi</p>




<p>Rep_dir="$Bakdir"mysqld-"$Date"/Rep</p>




<p>if [ "$Now_time" -eq  "00" ];then</p>




<p>/usr/bin/innobackupex-1.5.1 --user=$User --password=$Pwd --defaults-file=$Mysql_file --no-timestam --incremental  --incremental-basedir=$Bak_dir/full "$Bakdir"mysqld-"$Date"/Rep/00  1&gt;&gt;$Rep_log/log_$Log_time 2&gt;&amp;1            #Every day the first Rep</p>




<p>if [ -d "$Bak_dir" ];then                #gzip the last day backup</p>




<p>tar -C $Bakdir -cvf $Tar_dir/mysqld-"$Tar_date".tar.gz mysqld-"$Tar_date" 1&gt;&gt;$Rep_log/tarlog_$Log_time 2&gt;&amp;1<br />
else<br />
echo "The last day dump dot exist,Please Check" &gt;&gt;$Rep_log/tarlog_$Log_time</p>




<p>fi</p>




<p>fi</p>




<p>## Every day to Rep</p>




<p>for Time in `seq -w 1 23`;do                                     #pan duan  every hours</p>




<p>[ "$Time" -eq "$Now_time" -a ! -d "$Rep_dir/$Now_time" ] &amp;&amp;  /usr/bin/innobackupex-1.5.1 --user=$User --password=$Pwd --defaults-file=$Mysql_file --no-timestam  --incremental  --incremental-basedir=$Rep_dir/$Last_time  $Rep_dir/$Now_time 1&gt;&gt;$Rep_log/log_$Log_time 2&gt;&amp;1</p>




<p>done</p>




<p>#################################################################Restore bakup<br />
# if you want to restore full backup , Please run this command.</p>




<p>#first restore Full backup , (please remove the last databasedir all data ,see my.cnf ,rm -rf $Datadir )<br />
#if $datadir=/tmp/mysql/data<br />
# mv /tmp/mysql/data /tmp/mysql/data_bak<br />
#/usr/bin/innobackupex-1.5.1 --apply-log --reado-only --defaults-file=$Mysql_file --user=$User --password=$Pwd Bak_dir/full</p>




<p>#second, restort Incremental Backup, please  in turn time the number of<br />
#/usr/bin/innobackupex-1.5.1 --apply-log --reado-only --defaults-file=$Mysql_file --user=$User --password=$Pwd Bak_dir/full --incremental-dir=$Rep_dir/01</p>

]]></content>
  </entry>
  
</feed>
